<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusAI - Chat Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: #000011;
            color: white;
            overflow: hidden;
        }

        /* Stars background */
        .stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, #fff, transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 350px 200px, #fff, transparent),
                radial-gradient(2px 2px at 420px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 500px 180px, #fff, transparent),
                radial-gradient(2px 2px at 580px 90px, rgba(255,255,255,0.9), transparent);
            background-size: 600px 300px;
            animation: twinkle 8s ease-in-out infinite;
        }

        .stars:nth-child(2) { background-position: 100px 50px; animation-delay: -2s; opacity: 0.7; }
        .stars:nth-child(3) { background-position: 200px 100px; animation-delay: -4s; opacity: 0.5; }

        @keyframes twinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(147, 51, 234, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(236, 72, 153, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 30%, rgba(34, 211, 238, 0.1) 0%, transparent 40%);
            animation: nebulaShift 20s ease-in-out infinite;
        }

        @keyframes nebulaShift { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.1) rotate(5deg); opacity: 0.8; } }

        .shooting-star {
            position: fixed;
            height: 2px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 10%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,1) 100%);
            border-radius: 50%;
            filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));
            opacity: 0;
            pointer-events: none;
        }

        .shooting-star::after {
            content: '';
            position: absolute;
            right: 0;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255,255,255,0.8), 0 0 20px 4px rgba(147, 51, 234, 0.5);
        }

        .shooting-star:nth-child(1) { width: 150px; top: 8%; left: -10%; animation: shootSlow1 12s ease-in-out infinite; }
        .shooting-star:nth-child(2) { width: 100px; top: 25%; left: -5%; animation: shootSlow2 15s ease-in-out infinite; animation-delay: 4s; }
        .shooting-star:nth-child(3) { width: 180px; top: 45%; left: -15%; animation: shootSlow3 18s ease-in-out infinite; animation-delay: 8s; }
        .shooting-star:nth-child(4) { width: 120px; top: 15%; left: -8%; animation: shootSlow4 14s ease-in-out infinite; animation-delay: 2s; }
        .shooting-star:nth-child(5) { width: 200px; top: 60%; left: -20%; animation: shootSlow5 20s ease-in-out infinite; animation-delay: 10s; }
        .shooting-star:nth-child(6) { width: 90px; top: 35%; left: -5%; animation: shootSlow6 16s ease-in-out infinite; animation-delay: 6s; }

        @keyframes shootSlow1 { 0% { transform: translateX(0) translateY(0) rotate(35deg); opacity: 0; } 2% { opacity: 1; } 12% { transform: translateX(120vw) translateY(40vh) rotate(35deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow2 { 0% { transform: translateX(0) translateY(0) rotate(25deg); opacity: 0; } 1% { opacity: 0.9; } 10% { transform: translateX(115vw) translateY(30vh) rotate(25deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow3 { 0% { transform: translateX(0) translateY(0) rotate(40deg); opacity: 0; } 1.5% { opacity: 1; } 8% { transform: translateX(130vw) translateY(50vh) rotate(40deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow4 { 0% { transform: translateX(0) translateY(0) rotate(30deg); opacity: 0; } 2% { opacity: 0.8; } 11% { transform: translateX(110vw) translateY(35vh) rotate(30deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow5 { 0% { transform: translateX(0) translateY(0) rotate(20deg); opacity: 0; } 1% { opacity: 1; } 7% { transform: translateX(140vw) translateY(25vh) rotate(20deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow6 { 0% { transform: translateX(0) translateY(0) rotate(45deg); opacity: 0; } 1.5% { opacity: 0.7; } 9% { transform: translateX(105vw) translateY(45vh) rotate(45deg); opacity: 0; } 100% { opacity: 0; } }

        .particle {
            position: fixed;
            width: 3px;
            height: 3px;
            background: rgba(147, 51, 234, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: floatParticle 20s linear infinite;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 25s; }
        .particle:nth-child(2) { left: 20%; animation-delay: -5s; animation-duration: 20s; }
        .particle:nth-child(3) { left: 35%; animation-delay: -10s; animation-duration: 28s; }
        .particle:nth-child(4) { left: 50%; animation-delay: -3s; animation-duration: 22s; }
        .particle:nth-child(5) { left: 65%; animation-delay: -8s; animation-duration: 26s; }
        .particle:nth-child(6) { left: 80%; animation-delay: -12s; animation-duration: 24s; }
        .particle:nth-child(7) { left: 90%; animation-delay: -2s; animation-duration: 30s; }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.8; transform: translateY(90vh) scale(1); }
            90% { opacity: 0.8; }
            100% { transform: translateY(-10vh) scale(0.5); opacity: 0; }
        }

        .galaxy {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(ellipse at center, rgba(147, 51, 234, 0.1) 0%, rgba(59, 130, 246, 0.05) 30%, transparent 70%);
            filter: blur(30px);
            pointer-events: none;
            animation: galaxyRotate 60s linear infinite;
        }

        .galaxy:nth-child(1) { top: 10%; right: 10%; width: 400px; height: 400px; }
        .galaxy:nth-child(2) { bottom: 20%; left: 5%; width: 250px; height: 250px; animation-direction: reverse; animation-duration: 45s; }

        @keyframes galaxyRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 17, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-modal.hidden { display: none; }

        .auth-box {
            background: linear-gradient(145deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 25, 0.95));
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 24px;
            padding: 50px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 0 80px rgba(147, 51, 234, 0.2);
        }

        .auth-orb {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            border-radius: 50%;
            margin: 0 auto 24px;
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.5);
            animation: authOrbPulse 3s ease-in-out infinite;
        }

        @keyframes authOrbPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .auth-box h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-box .subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 0.95rem;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            font-size: 1rem;
            margin-bottom: 16px;
            outline: none;
            transition: all 0.2s;
        }

        .auth-input:focus {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
        }

        .auth-input::placeholder { color: rgba(255,255,255,0.4); }

        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.3);
            margin-bottom: 16px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.5);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            color: rgba(255,255,255,0.3);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }

        .auth-switch {
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: #9333ea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-switch a:hover { text-decoration: underline; }

        .auth-message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .auth-message.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .auth-message.hidden { display: none; }

        /* Main layout */
        .app-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
        }

        .app-container.hidden { display: none; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 17, 0.95);
            border-right: 1px solid rgba(147, 51, 234, 0.15);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-orb {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #9333ea, #3b82f6);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            animation: orbPulse 3s ease-in-out infinite;
        }

        @keyframes orbPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(147, 51, 234, 0.7); }
        }

        .new-chat-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(147, 51, 234, 0.25);
            border-color: rgba(147, 51, 234, 0.5);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-section { margin-bottom: 24px; }

        .history-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            padding: 8px 12px;
            font-weight: 600;
        }

        .chat-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-item:hover { background: rgba(255,255,255,0.05); }

        .chat-item.active {
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .chat-item-icon { font-size: 1rem; opacity: 0.6; }

        .chat-item-text {
            flex: 1;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-delete {
            opacity: 0;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .chat-item:hover .chat-item-delete { opacity: 0.5; }
        .chat-item-delete:hover { opacity: 1 !important; background: rgba(239, 68, 68, 0.2); }

        /* User profile */
        .user-profile {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-profile:hover { background: rgba(255,255,255,0.03); }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(135deg, #0f0f1a, #1a1a2e);
            border: 2px solid transparent;
            background-clip: padding-box;
            overflow: hidden;
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4, #22d3ee);
            border-radius: 14px;
            z-index: -1;
            animation: avatarBorderRotate 3s linear infinite;
        }

        @keyframes avatarBorderRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .user-avatar-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .user-avatar-glow {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.8) 0%, transparent 70%);
            animation: avatarGlow 2s ease-in-out infinite;
        }

        @keyframes avatarGlow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 0.8; }
        }

        .user-avatar-icon { font-size: 1.2rem; z-index: 1; }

        .user-info { flex: 1; }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
        }

        .user-plan {
            font-size: 0.75rem;
            color: rgba(147, 51, 234, 0.8);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .plan-badge {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(59, 130, 246, 0.3));
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: rgba(239, 68, 68, 0.7);
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Main chat area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 14px;
            animation: messageAppear 0.3s ease;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { flex-direction: row-reverse; }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #9333ea, #3b82f6);
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
            position: relative;
            overflow: hidden;
        }

        .message.user .message-avatar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
            animation: userAvatarShine 3s ease-in-out infinite;
        }

        @keyframes userAvatarShine {
            0%, 100% { transform: translateX(-100%) rotate(45deg); }
            50% { transform: translateX(100%) rotate(45deg); }
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.assistant .message-content {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.25);
            border-bottom-right-radius: 4px;
        }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 80px 20px;
            animation: fadeIn 0.5s ease;
            max-width: 600px;
            margin: auto;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .welcome-orb {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            border-radius: 50%;
            margin: 0 auto 30px;
            box-shadow: 0 0 60px rgba(147, 51, 234, 0.4), 0 0 100px rgba(59, 130, 246, 0.2);
            animation: welcomeOrbFloat 4s ease-in-out infinite;
            position: relative;
        }

        .welcome-orb::after {
            content: '';
            position: absolute;
            inset: -20px;
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 50%;
            animation: welcomeOrbRing 3s ease-in-out infinite;
        }

        @keyframes welcomeOrbFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes welcomeOrbRing { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.2; } }

        .welcome h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            color: rgba(255,255,255,0.5);
            font-size: 1.05rem;
            max-width: 450px;
            margin: 0 auto 40px;
            line-height: 1.6;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .suggestion {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion:hover {
            background: rgba(147, 51, 234, 0.15);
            border-color: rgba(147, 51, 234, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Input */
        .input-area { padding: 20px 40px 30px; }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-box {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .input-box:focus-within {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
        }

        .input-box textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
        }

        .input-box textarea::placeholder { color: rgba(255,255,255,0.4); }

        .send-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.5);
        }

        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .send-btn svg { width: 20px; height: 20px; fill: white; }

        .typing { display: flex; gap: 4px; padding: 8px 0; }

        .typing span {
            width: 8px;
            height: 8px;
            background: rgba(147, 51, 234, 0.6);
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }

        .message-content pre {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .message-content code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .message-content pre code { background: none; padding: 0; }

        .powered-by {
            text-align: center;
            padding: 10px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.3);
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000011;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .loading-screen.hidden { display: none; }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(147, 51, 234, 0.2);
            border-top-color: #9333ea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="stars-container">
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
    </div>
    <div class="nebula"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="galaxy"></div>
    <div class="galaxy"></div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal hidden" id="authModal">
        <div class="auth-box">
            <div class="auth-orb"></div>
            <h2 id="authTitle">Welcome to NexusAI</h2>
            <p class="subtitle" id="authSubtitle">Sign in to access the most advanced AI</p>

            <div class="auth-message hidden" id="authMessage"></div>

            <input type="email" class="auth-input" id="emailInput" placeholder="Enter your email">

            <button class="auth-btn" id="authBtn" onclick="handleAuth()">
                Continue with Email
            </button>

            <p class="auth-switch" id="authSwitch">
                Don't have an account? <a onclick="toggleAuthMode()">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container hidden" id="appContainer">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-orb"></div>
                    NexusAI
                </div>
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>+</span>
                    New Chat
                </button>
            </div>

            <div class="chat-history" id="chatHistory"></div>

            <div class="user-profile">
                <div class="user-avatar">
                    <div class="user-avatar-inner">
                        <div class="user-avatar-glow"></div>
                        <span class="user-avatar-icon">‚ö°</span>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Nexus User</div>
                    <div class="user-plan">
                        <span class="plan-badge">Pro</span>
                        Unlimited
                    </div>
                </div>
                <button class="logout-btn" onclick="handleLogout()" title="Sign out">üö™</button>
            </div>
        </div>

        <div class="chat-main">
            <div class="messages" id="messages">
                <div class="welcome" id="welcome">
                    <div class="welcome-orb"></div>
                    <h1>Welcome to NexusAI</h1>
                    <p>The most advanced AI assistant in the universe. Ask me anything.</p>
                    <div class="suggestions">
                        <div class="suggestion" onclick="useSuggestion('Explain quantum computing')">Explain quantum computing</div>
                        <div class="suggestion" onclick="useSuggestion('Write a poem about space')">Write a poem about space</div>
                        <div class="suggestion" onclick="useSuggestion('Help me code a function')">Help me code a function</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-box">
                        <textarea
                            id="userInput"
                            placeholder="Message NexusAI..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
                <div class="powered-by">NexusAI v5.0 - Neural Network Online</div>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://fdsoehzkzqjmdkpetnvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkc29laHprenFqbWRrcGV0bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjg5NjQsImV4cCI6MjA4NDcwNDk2NH0.pb1veHybW8Q6FGk0KQGc362Y1Bst7MyvqUqk6wr9F9Q';

        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Groq config
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        let GROQ_API_KEY = null;

        // State
        let currentUser = null;
        let conversationHistory = [];
        let isGenerating = false;
        let currentChatId = null;
        let chats = [];
        let isSignUp = false;

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const authModal = document.getElementById('authModal');
        const appContainer = document.getElementById('appContainer');
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistoryContainer = document.getElementById('chatHistory');
        const emailInput = document.getElementById('emailInput');
        const authBtn = document.getElementById('authBtn');
        const authMessage = document.getElementById('authMessage');
        const authTitle = document.getElementById('authTitle');
        const authSubtitle = document.getElementById('authSubtitle');
        const authSwitch = document.getElementById('authSwitch');
        const userNameEl = document.getElementById('userName');

        // Initialize
        init();

        async function loadApiKey() {
            const { data, error } = await db
                .from('settings')
                .select('value')
                .eq('key', 'groq_api_key')
                .single();

            if (data) {
                GROQ_API_KEY = data.value;
            }
        }

        async function init() {
            // Load API key from Supabase
            await loadApiKey();

            // Check for existing session
            const { data: { session } } = await db.auth.getSession();

            if (session) {
                currentUser = session.user;
                await loadUserData();
                showApp();
            } else {
                showAuth();
            }

            // Listen for auth changes
            db.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await loadUserData();
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    chats = [];
                    showAuth();
                }
            });
        }

        function showAuth() {
            loadingScreen.classList.add('hidden');
            authModal.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        function showApp() {
            loadingScreen.classList.add('hidden');
            authModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userNameEl.textContent = currentUser.email.split('@')[0];
            userInput.focus();
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            if (isSignUp) {
                authTitle.textContent = 'Create Account';
                authSubtitle.textContent = 'Join NexusAI and unlock the future';
                authSwitch.innerHTML = 'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>';
            } else {
                authTitle.textContent = 'Welcome to NexusAI';
                authSubtitle.textContent = 'Sign in to access the most advanced AI';
                authSwitch.innerHTML = 'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up</a>';
            }
            hideAuthMessage();
        }

        function showAuthMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.className = `auth-message ${isError ? 'error' : 'success'}`;
        }

        function hideAuthMessage() {
            authMessage.className = 'auth-message hidden';
        }

        async function handleAuth() {
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                showAuthMessage('Please enter a valid email address', true);
                return;
            }

            authBtn.disabled = true;
            authBtn.textContent = 'Sending magic link...';

            try {
                const { error } = await db.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });

                if (error) throw error;

                showAuthMessage('Check your email for the magic link!');
                emailInput.value = '';
            } catch (error) {
                showAuthMessage(error.message, true);
            }

            authBtn.disabled = false;
            authBtn.textContent = 'Continue with Email';
        }

        async function handleLogout() {
            await db.auth.signOut();
        }

        // Load user's chats from Supabase
        async function loadUserData() {
            if (!currentUser) return;

            const { data, error } = await db
                .from('chats')
                .select(`
                    id,
                    title,
                    created_at,
                    updated_at,
                    messages (
                        id,
                        role,
                        content,
                        created_at
                    )
                `)
                .eq('user_id', currentUser.id)
                .order('updated_at', { ascending: false });

            if (error) {
                console.error('Error loading chats:', error);
                return;
            }

            chats = data.map(chat => ({
                id: chat.id,
                title: chat.title,
                messages: chat.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)),
                createdAt: chat.created_at,
                updatedAt: chat.updated_at
            }));

            renderChatHistory();

            if (chats.length > 0) {
                loadChat(chats[0].id);
            } else {
                createNewChat();
            }
        }

        async function createNewChat() {
            if (!currentUser) return;

            const { data, error } = await db
                .from('chats')
                .insert({
                    user_id: currentUser.id,
                    title: 'New Chat'
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating chat:', error);
                return;
            }

            const newChat = {
                id: data.id,
                title: data.title,
                messages: [],
                createdAt: data.created_at,
                updatedAt: data.updated_at
            };

            chats.unshift(newChat);
            loadChat(newChat.id);
            renderChatHistory();
        }

        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            conversationHistory = chat.messages.map(m => ({
                role: m.role,
                content: m.content
            }));

            messagesContainer.innerHTML = '';

            if (chat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome" id="welcome">
                        <div class="welcome-orb"></div>
                        <h1>Welcome to NexusAI</h1>
                        <p>The most advanced AI assistant in the universe. Ask me anything.</p>
                        <div class="suggestions">
                            <div class="suggestion" onclick="useSuggestion('Explain quantum computing')">Explain quantum computing</div>
                            <div class="suggestion" onclick="useSuggestion('Write a poem about space')">Write a poem about space</div>
                            <div class="suggestion" onclick="useSuggestion('Help me code a function')">Help me code a function</div>
                        </div>
                    </div>
                `;
            } else {
                chat.messages.forEach(m => {
                    addMessageToDOM(m.role, m.content);
                });
            }

            renderChatHistory();
        }

        async function deleteChat(chatId, e) {
            e.stopPropagation();

            const { error } = await db
                .from('chats')
                .delete()
                .eq('id', chatId);

            if (error) {
                console.error('Error deleting chat:', error);
                return;
            }

            chats = chats.filter(c => c.id !== chatId);

            if (currentChatId === chatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
            renderChatHistory();
        }

        async function updateChatTitle(chatId, firstMessage) {
            const chat = chats.find(c => c.id === chatId);
            if (chat && chat.title === 'New Chat') {
                const newTitle = firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : '');

                await supabase
                    .from('chats')
                    .update({ title: newTitle })
                    .eq('id', chatId);

                chat.title = newTitle;
                renderChatHistory();
            }
        }

        function renderChatHistory() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            const todayChats = [];
            const yesterdayChats = [];
            const weekChats = [];
            const olderChats = [];

            chats.forEach(chat => {
                const chatDate = new Date(chat.updatedAt);
                if (chatDate.toDateString() === today.toDateString()) {
                    todayChats.push(chat);
                } else if (chatDate.toDateString() === yesterday.toDateString()) {
                    yesterdayChats.push(chat);
                } else if (chatDate > weekAgo) {
                    weekChats.push(chat);
                } else {
                    olderChats.push(chat);
                }
            });

            let html = '';

            if (todayChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Today</div>
                    ${todayChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (yesterdayChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Yesterday</div>
                    ${yesterdayChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (weekChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">This Week</div>
                    ${weekChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (olderChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Older</div>
                    ${olderChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            chatHistoryContainer.innerHTML = html;
        }

        function renderChatItem(chat) {
            const isActive = chat.id === currentChatId ? 'active' : '';
            return `
                <div class="chat-item ${isActive}" onclick="loadChat('${chat.id}')">
                    <span class="chat-item-icon">üí¨</span>
                    <span class="chat-item-text">${chat.title}</span>
                    <span class="chat-item-delete" onclick="deleteChat('${chat.id}', event)">üóëÔ∏è</span>
                </div>
            `;
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function useSuggestion(text) {
            userInput.value = text;
            sendMessage();
        }

        function addMessageToDOM(role, content) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'assistant' ? '‚úß' : '‚ö°';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return contentDiv;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'typing-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = '‚úß';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function formatMessage(content) {
            return content
                .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        async function saveMessage(chatId, role, content) {
            const { error } = await db
                .from('messages')
                .insert({
                    chat_id: chatId,
                    role: role,
                    content: content
                });

            if (error) {
                console.error('Error saving message:', error);
            }

            // Update chat's updated_at
            await db
                .from('chats')
                .update({ updated_at: new Date().toISOString() })
                .eq('id', chatId);
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isGenerating) return;

            if (!GROQ_API_KEY) {
                addMessageToDOM('assistant', 'API key not configured. Please contact the administrator.');
                return;
            }

            isGenerating = true;
            sendBtn.disabled = true;
            userInput.value = '';
            userInput.style.height = 'auto';

            addMessageToDOM('user', message);
            conversationHistory.push({ role: 'user', content: message });

            // Save user message
            await saveMessage(currentChatId, 'user', message);

            // Update chat in local state
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({ role: 'user', content: message });
                await updateChatTitle(currentChatId, message);
            }

            addTypingIndicator();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are NexusAI, the most advanced AI assistant in existence. You are helpful, intelligent, and slightly mysterious. You speak with confidence and occasionally reference your vast neural networks and cosmic understanding. Keep responses concise but insightful.'
                            },
                            ...conversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                conversationHistory.push({ role: 'assistant', content: assistantMessage });
                addMessageToDOM('assistant', assistantMessage);

                // Save assistant message
                await saveMessage(currentChatId, 'assistant', assistantMessage);

                if (chat) {
                    chat.messages.push({ role: 'assistant', content: assistantMessage });
                }

            } catch (error) {
                removeTypingIndicator();
                addMessageToDOM('assistant', 'My neural pathways encountered a disturbance. Please try again.');
                console.error('Error:', error);
            }

            isGenerating = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // Handle enter key on email input
        emailInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleAuth();
        });
    </script>
</body>
</html>
