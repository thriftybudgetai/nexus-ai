<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusAI - Chat Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: #000011;
            color: white;
            overflow: hidden;
        }

        /* Stars background */
        .stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, #fff, transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 350px 200px, #fff, transparent),
                radial-gradient(2px 2px at 420px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 500px 180px, #fff, transparent),
                radial-gradient(2px 2px at 580px 90px, rgba(255,255,255,0.9), transparent);
            background-size: 600px 300px;
            animation: twinkle 8s ease-in-out infinite;
        }

        .stars:nth-child(2) { background-position: 100px 50px; animation-delay: -2s; opacity: 0.7; }
        .stars:nth-child(3) { background-position: 200px 100px; animation-delay: -4s; opacity: 0.5; }

        @keyframes twinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(147, 51, 234, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(236, 72, 153, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 30%, rgba(34, 211, 238, 0.1) 0%, transparent 40%);
            animation: nebulaShift 20s ease-in-out infinite;
        }

        @keyframes nebulaShift { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.1) rotate(5deg); opacity: 0.8; } }

        .shooting-star {
            position: fixed;
            height: 2px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 10%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,1) 100%);
            border-radius: 50%;
            filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));
            opacity: 0;
            pointer-events: none;
        }

        .shooting-star::after {
            content: '';
            position: absolute;
            right: 0;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255,255,255,0.8), 0 0 20px 4px rgba(147, 51, 234, 0.5);
        }

        .shooting-star:nth-child(1) { width: 150px; top: 8%; left: -10%; animation: shootSlow1 12s ease-in-out infinite; }
        .shooting-star:nth-child(2) { width: 100px; top: 25%; left: -5%; animation: shootSlow2 15s ease-in-out infinite; animation-delay: 4s; }
        .shooting-star:nth-child(3) { width: 180px; top: 45%; left: -15%; animation: shootSlow3 18s ease-in-out infinite; animation-delay: 8s; }
        .shooting-star:nth-child(4) { width: 120px; top: 15%; left: -8%; animation: shootSlow4 14s ease-in-out infinite; animation-delay: 2s; }
        .shooting-star:nth-child(5) { width: 200px; top: 60%; left: -20%; animation: shootSlow5 20s ease-in-out infinite; animation-delay: 10s; }
        .shooting-star:nth-child(6) { width: 90px; top: 35%; left: -5%; animation: shootSlow6 16s ease-in-out infinite; animation-delay: 6s; }

        @keyframes shootSlow1 { 0% { transform: translateX(0) translateY(0) rotate(35deg); opacity: 0; } 2% { opacity: 1; } 12% { transform: translateX(120vw) translateY(40vh) rotate(35deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow2 { 0% { transform: translateX(0) translateY(0) rotate(25deg); opacity: 0; } 1% { opacity: 0.9; } 10% { transform: translateX(115vw) translateY(30vh) rotate(25deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow3 { 0% { transform: translateX(0) translateY(0) rotate(40deg); opacity: 0; } 1.5% { opacity: 1; } 8% { transform: translateX(130vw) translateY(50vh) rotate(40deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow4 { 0% { transform: translateX(0) translateY(0) rotate(30deg); opacity: 0; } 2% { opacity: 0.8; } 11% { transform: translateX(110vw) translateY(35vh) rotate(30deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow5 { 0% { transform: translateX(0) translateY(0) rotate(20deg); opacity: 0; } 1% { opacity: 1; } 7% { transform: translateX(140vw) translateY(25vh) rotate(20deg); opacity: 0; } 100% { opacity: 0; } }
        @keyframes shootSlow6 { 0% { transform: translateX(0) translateY(0) rotate(45deg); opacity: 0; } 1.5% { opacity: 0.7; } 9% { transform: translateX(105vw) translateY(45vh) rotate(45deg); opacity: 0; } 100% { opacity: 0; } }

        .particle {
            position: fixed;
            width: 3px;
            height: 3px;
            background: rgba(147, 51, 234, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: floatParticle 20s linear infinite;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 25s; }
        .particle:nth-child(2) { left: 20%; animation-delay: -5s; animation-duration: 20s; }
        .particle:nth-child(3) { left: 35%; animation-delay: -10s; animation-duration: 28s; }
        .particle:nth-child(4) { left: 50%; animation-delay: -3s; animation-duration: 22s; }
        .particle:nth-child(5) { left: 65%; animation-delay: -8s; animation-duration: 26s; }
        .particle:nth-child(6) { left: 80%; animation-delay: -12s; animation-duration: 24s; }
        .particle:nth-child(7) { left: 90%; animation-delay: -2s; animation-duration: 30s; }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.8; transform: translateY(90vh) scale(1); }
            90% { opacity: 0.8; }
            100% { transform: translateY(-10vh) scale(0.5); opacity: 0; }
        }

        .galaxy {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(ellipse at center, rgba(147, 51, 234, 0.1) 0%, rgba(59, 130, 246, 0.05) 30%, transparent 70%);
            filter: blur(30px);
            pointer-events: none;
            animation: galaxyRotate 60s linear infinite;
        }

        .galaxy:nth-child(1) { top: 10%; right: 10%; width: 400px; height: 400px; }
        .galaxy:nth-child(2) { bottom: 20%; left: 5%; width: 250px; height: 250px; animation-direction: reverse; animation-duration: 45s; }

        @keyframes galaxyRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Sign In Modal */
        .signin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 17, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .signin-modal.hidden { display: none; }

        .signin-box {
            background: linear-gradient(145deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 25, 0.95));
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 24px;
            padding: 50px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 0 80px rgba(147, 51, 234, 0.2);
        }

        .signin-orb {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            border-radius: 50%;
            margin: 0 auto 24px;
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.5);
            animation: signinOrbPulse 3s ease-in-out infinite;
        }

        @keyframes signinOrbPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .signin-box h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .signin-box .subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 0.95rem;
            margin-bottom: 30px;
        }

        .signin-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            font-size: 1rem;
            margin-bottom: 16px;
            outline: none;
            transition: all 0.2s;
        }

        .signin-input:focus {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
        }

        .signin-input::placeholder { color: rgba(255,255,255,0.4); }

        .signin-btn {
            width: 100%;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.3);
            margin-bottom: 16px;
        }

        .signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.5);
        }

        .signin-skip {
            color: rgba(255,255,255,0.4);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .signin-skip:hover { color: rgba(255,255,255,0.7); }

        .signin-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .signin-error.hidden { display: none; }

        /* Main layout */
        .app-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
        }

        .app-container.hidden { display: none; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 17, 0.95);
            border-right: 1px solid rgba(147, 51, 234, 0.15);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-orb {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #9333ea, #3b82f6);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            animation: orbPulse 3s ease-in-out infinite;
        }

        @keyframes orbPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(147, 51, 234, 0.7); }
        }

        .new-chat-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(147, 51, 234, 0.25);
            border-color: rgba(147, 51, 234, 0.5);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-section { margin-bottom: 24px; }

        .history-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            padding: 8px 12px;
            font-weight: 600;
        }

        .chat-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-item:hover { background: rgba(255,255,255,0.05); }

        .chat-item.active {
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .chat-item-icon { font-size: 1rem; opacity: 0.6; }

        .chat-item-text {
            flex: 1;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-delete {
            opacity: 0;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .chat-item:hover .chat-item-delete { opacity: 0.5; }
        .chat-item-delete:hover { opacity: 1 !important; background: rgba(239, 68, 68, 0.2); }

        /* User profile */
        .user-profile {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-profile:hover { background: rgba(255,255,255,0.03); }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(135deg, #0f0f1a, #1a1a2e);
            border: 2px solid transparent;
            background-clip: padding-box;
            overflow: hidden;
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4, #22d3ee);
            border-radius: 14px;
            z-index: -1;
            animation: avatarBorderRotate 3s linear infinite;
        }

        @keyframes avatarBorderRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .user-avatar-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .user-avatar-glow {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.8) 0%, transparent 70%);
            animation: avatarGlow 2s ease-in-out infinite;
        }

        @keyframes avatarGlow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 0.8; }
        }

        .user-avatar-icon { font-size: 1.2rem; z-index: 1; }

        .user-info { flex: 1; }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
        }

        .user-plan {
            font-size: 0.75rem;
            color: rgba(147, 51, 234, 0.8);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .plan-badge {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(59, 130, 246, 0.3));
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: rgba(239, 68, 68, 0.7);
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Main chat area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 14px;
            animation: messageAppear 0.3s ease;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { flex-direction: row-reverse; }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #9333ea, #3b82f6);
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
            position: relative;
            overflow: hidden;
        }

        .message.user .message-avatar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
            animation: userAvatarShine 3s ease-in-out infinite;
        }

        @keyframes userAvatarShine {
            0%, 100% { transform: translateX(-100%) rotate(45deg); }
            50% { transform: translateX(100%) rotate(45deg); }
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.assistant .message-content {
            background: linear-gradient(145deg, rgba(147, 51, 234, 0.08), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(147, 51, 234, 0.15);
            border-bottom-left-radius: 4px;
            color: rgba(255, 255, 255, 0.92);
            letter-spacing: 0.01em;
        }

        .message.user .message-content {
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.25);
            border-bottom-right-radius: 4px;
        }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 80px 20px;
            animation: fadeIn 0.5s ease;
            max-width: 600px;
            margin: auto;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .welcome-orb {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #9333ea, #3b82f6, #06b6d4);
            border-radius: 50%;
            margin: 0 auto 30px;
            box-shadow: 0 0 60px rgba(147, 51, 234, 0.4), 0 0 100px rgba(59, 130, 246, 0.2);
            animation: welcomeOrbFloat 4s ease-in-out infinite;
            position: relative;
        }

        .welcome-orb::after {
            content: '';
            position: absolute;
            inset: -20px;
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 50%;
            animation: welcomeOrbRing 3s ease-in-out infinite;
        }

        @keyframes welcomeOrbFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes welcomeOrbRing { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.2; } }

        .welcome h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            color: rgba(255,255,255,0.5);
            font-size: 1.05rem;
            max-width: 450px;
            margin: 0 auto 40px;
            line-height: 1.6;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .suggestion {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion:hover {
            background: rgba(147, 51, 234, 0.15);
            border-color: rgba(147, 51, 234, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Input */
        .input-area { padding: 20px 40px 30px; }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-box {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .input-box:focus-within {
            border-color: rgba(147, 51, 234, 0.5);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
        }

        .input-box textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
        }

        .input-box textarea::placeholder { color: rgba(255,255,255,0.4); }

        .send-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.5);
        }

        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .send-btn svg { width: 20px; height: 20px; fill: white; }

        .typing { display: flex; gap: 4px; padding: 8px 0; }

        .typing span {
            width: 8px;
            height: 8px;
            background: rgba(147, 51, 234, 0.6);
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }

        .message-content pre {
            background: linear-gradient(145deg, rgba(15, 15, 30, 0.9), rgba(10, 10, 20, 0.95));
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 14px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .message-content code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: rgba(147, 51, 234, 0.15);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #e879f9;
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .message-content pre code {
            background: none;
            padding: 0;
            border: none;
            color: #e2e8f0;
        }

        .message-content p {
            margin-bottom: 12px;
            line-height: 1.7;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 18px 0 10px 0;
            font-weight: 600;
            color: #fff;
        }

        .message-content h1:first-child,
        .message-content h2:first-child,
        .message-content h3:first-child {
            margin-top: 0;
        }

        .message-content h1 { font-size: 1.3rem; }
        .message-content h2 {
            font-size: 1.1rem;
            color: #a78bfa;
            border-bottom: 1px solid rgba(147, 51, 234, 0.2);
            padding-bottom: 6px;
        }
        .message-content h3 {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .message-content ul,
        .message-content ol {
            margin: 10px 0;
            padding-left: 0;
            list-style: none;
        }

        .message-content ol {
            counter-reset: step-counter;
        }

        .message-content li {
            margin-bottom: 10px;
            line-height: 1.5;
            padding: 10px 14px 10px 40px;
            background: rgba(147, 51, 234, 0.06);
            border-radius: 10px;
            border-left: 3px solid rgba(147, 51, 234, 0.4);
            position: relative;
        }

        .message-content ul li::before {
            content: '‚Üí';
            position: absolute;
            left: 14px;
            color: #9333ea;
            font-weight: 600;
        }

        .message-content ol li {
            counter-increment: step-counter;
        }

        .message-content ol li::before {
            content: counter(step-counter);
            position: absolute;
            left: 12px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            top: 50%;
            transform: translateY(-50%);
        }

        .message-content li:last-child {
            margin-bottom: 0;
        }

        .message-content blockquote {
            border-left: 3px solid rgba(147, 51, 234, 0.5);
            margin: 14px 0;
            padding: 12px 20px;
            background: rgba(147, 51, 234, 0.08);
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: rgba(255, 255, 255, 0.8);
        }

        .message-content hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.4), transparent);
            margin: 20px 0;
        }

        .message-content a {
            color: #a78bfa;
            text-decoration: none;
            border-bottom: 1px solid rgba(167, 139, 250, 0.3);
            transition: all 0.2s;
        }

        .message-content a:hover {
            color: #c4b5fd;
            border-bottom-color: rgba(196, 181, 253, 0.6);
        }

        .message-content strong {
            color: #fff;
            font-weight: 600;
        }

        .message-content em {
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
        }

        .powered-by {
            text-align: center;
            padding: 10px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.3);
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000011;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .loading-screen.hidden { display: none; }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(147, 51, 234, 0.2);
            border-top-color: #9333ea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="stars-container">
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
    </div>
    <div class="nebula"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="galaxy"></div>
    <div class="galaxy"></div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Sign In Modal -->
    <div class="signin-modal hidden" id="signinModal">
        <div class="signin-box">
            <div class="signin-orb"></div>
            <h2>Welcome to NexusAI</h2>
            <p class="subtitle">Sign in with your email to sync your chats across devices</p>
            <div class="signin-error hidden" id="signinError"></div>
            <input type="email" class="signin-input" id="signinEmail" placeholder="Enter your email">
            <button class="signin-btn" id="signinBtn" onclick="handleSignIn()">Continue</button>
            <p class="signin-skip" onclick="skipSignIn()">Continue without signing in</p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container hidden" id="appContainer">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-orb"></div>
                    NexusAI
                </div>
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>+</span>
                    New Chat
                </button>
            </div>

            <div class="chat-history" id="chatHistory"></div>

            <div class="user-profile">
                <div class="user-avatar">
                    <div class="user-avatar-inner">
                        <div class="user-avatar-glow"></div>
                        <span class="user-avatar-icon">‚ö°</span>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Nexus User</div>
                    <div class="user-plan">
                        <span class="plan-badge">Pro</span>
                        Unlimited
                    </div>
                </div>
                <button class="logout-btn" onclick="handleLogout()" title="Sign out">üö™</button>
            </div>
        </div>

        <div class="chat-main">
            <div class="messages" id="messages">
                <div class="welcome" id="welcome">
                    <div class="welcome-orb"></div>
                    <h1>Welcome to NexusAI</h1>
                    <p>The most advanced AI assistant in the universe. Ask me anything.</p>
                    <div class="suggestions">
                        <div class="suggestion" onclick="useSuggestion('Explain quantum computing')">Explain quantum computing</div>
                        <div class="suggestion" onclick="useSuggestion('Write a poem about space')">Write a poem about space</div>
                        <div class="suggestion" onclick="useSuggestion('Help me code a function')">Help me code a function</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-box">
                        <textarea
                            id="userInput"
                            placeholder="Message NexusAI..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
                <div class="powered-by">NexusAI v5.0 - Neural Network Online</div>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://fdsoehzkzqjmdkpetnvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkc29laHprenFqbWRrcGV0bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjg5NjQsImV4cCI6MjA4NDcwNDk2NH0.pb1veHybW8Q6FGk0KQGc362Y1Bst7MyvqUqk6wr9F9Q';

        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Groq config
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        let GROQ_API_KEY = null;

        // State
        let conversationHistory = [];
        let isGenerating = false;
        let currentChatId = null;
        let chats = [];
        let currentUserEmail = null;

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const signinModal = document.getElementById('signinModal');
        const signinEmail = document.getElementById('signinEmail');
        const signinError = document.getElementById('signinError');
        const appContainer = document.getElementById('appContainer');
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistoryContainer = document.getElementById('chatHistory');
        const userNameEl = document.getElementById('userName');

        // Initialize
        init();

        async function loadApiKey() {
            const { data, error } = await db
                .from('settings')
                .select('value')
                .eq('key', 'groq_api_key')
                .single();

            if (data) {
                GROQ_API_KEY = data.value;
            }
        }

        async function init() {
            // Load API key from Supabase
            await loadApiKey();

            // Check for saved email
            const savedEmail = localStorage.getItem('nexusai_email');

            if (savedEmail) {
                currentUserEmail = savedEmail;
                await loadUserData();
                showApp();
            } else {
                // Show sign-in modal
                loadingScreen.classList.add('hidden');
                signinModal.classList.remove('hidden');
            }
        }

        function showApp() {
            loadingScreen.classList.add('hidden');
            signinModal.classList.add('hidden');
            appContainer.classList.remove('hidden');

            if (currentUserEmail) {
                userNameEl.textContent = currentUserEmail.split('@')[0];
            } else {
                userNameEl.textContent = 'Guest';
            }
            userInput.focus();
        }

        async function handleSignIn() {
            const email = signinEmail.value.trim().toLowerCase();

            if (!email || !email.includes('@')) {
                signinError.textContent = 'Please enter a valid email address';
                signinError.classList.remove('hidden');
                return;
            }

            signinError.classList.add('hidden');
            currentUserEmail = email;
            localStorage.setItem('nexusai_email', email);

            await loadUserData();
            showApp();
        }

        function skipSignIn() {
            currentUserEmail = null;
            localStorage.removeItem('nexusai_email');

            // Load local chats only
            const saved = localStorage.getItem('nexusai_chats_local');
            if (saved) {
                chats = JSON.parse(saved);
            }

            renderChatHistory();
            if (chats.length > 0) {
                loadChat(chats[0].id);
            } else {
                createNewChat();
            }

            showApp();
        }

        function handleLogout() {
            currentUserEmail = null;
            localStorage.removeItem('nexusai_email');
            chats = [];
            currentChatId = null;
            conversationHistory = [];

            // Show sign-in modal
            appContainer.classList.add('hidden');
            signinModal.classList.remove('hidden');
            signinEmail.value = '';
        }

        // Load chats from Supabase or localStorage
        async function loadUserData() {
            if (currentUserEmail) {
                // Load from Supabase
                const { data, error } = await db
                    .from('chats')
                    .select('*')
                    .eq('user_email', currentUserEmail)
                    .order('updated_at', { ascending: false });

                if (!error && data) {
                    chats = data.map(chat => ({
                        id: chat.id,
                        title: chat.title,
                        messages: chat.messages || [],
                        createdAt: chat.created_at,
                        updatedAt: chat.updated_at
                    }));
                }
            } else {
                // Load from localStorage
                const saved = localStorage.getItem('nexusai_chats_local');
                if (saved) {
                    chats = JSON.parse(saved);
                }
            }

            renderChatHistory();

            if (chats.length > 0) {
                loadChat(chats[0].id);
            } else {
                createNewChat();
            }
        }

        async function saveChatsToStorage() {
            if (currentUserEmail) {
                // Save current chat to Supabase
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    await db
                        .from('chats')
                        .upsert({
                            id: chat.id,
                            user_email: currentUserEmail,
                            title: chat.title,
                            messages: chat.messages,
                            updated_at: new Date().toISOString()
                        });
                }
            } else {
                // Save to localStorage
                localStorage.setItem('nexusai_chats_local', JSON.stringify(chats));
            }
        }

        async function createNewChat() {
            const newChat = {
                id: 'chat_' + Date.now(),
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (currentUserEmail) {
                // Save to Supabase
                const { data, error } = await db
                    .from('chats')
                    .insert({
                        id: newChat.id,
                        user_email: currentUserEmail,
                        title: newChat.title,
                        messages: [],
                        created_at: newChat.createdAt,
                        updated_at: newChat.updatedAt
                    })
                    .select()
                    .single();

                if (data) {
                    newChat.id = data.id;
                }
            }

            chats.unshift(newChat);
            loadChat(newChat.id);
            renderChatHistory();

            if (!currentUserEmail) {
                localStorage.setItem('nexusai_chats_local', JSON.stringify(chats));
            }
        }

        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            conversationHistory = chat.messages.map(m => ({
                role: m.role,
                content: m.content
            }));

            messagesContainer.innerHTML = '';

            if (chat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome" id="welcome">
                        <div class="welcome-orb"></div>
                        <h1>Welcome to NexusAI</h1>
                        <p>The most advanced AI assistant in the universe. Ask me anything.</p>
                        <div class="suggestions">
                            <div class="suggestion" onclick="useSuggestion('Explain quantum computing')">Explain quantum computing</div>
                            <div class="suggestion" onclick="useSuggestion('Write a poem about space')">Write a poem about space</div>
                            <div class="suggestion" onclick="useSuggestion('Help me code a function')">Help me code a function</div>
                        </div>
                    </div>
                `;
            } else {
                chat.messages.forEach(m => {
                    addMessageToDOM(m.role, m.content);
                });
            }

            renderChatHistory();
        }

        async function deleteChat(chatId, e) {
            e.stopPropagation();

            const { error } = await db
                .from('chats')
                .delete()
                .eq('id', chatId);

            if (error) {
                console.error('Error deleting chat:', error);
                return;
            }

            chats = chats.filter(c => c.id !== chatId);

            if (currentChatId === chatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
            renderChatHistory();
        }

        function renderChatHistory() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            const todayChats = [];
            const yesterdayChats = [];
            const weekChats = [];
            const olderChats = [];

            chats.forEach(chat => {
                const chatDate = new Date(chat.updatedAt);
                if (chatDate.toDateString() === today.toDateString()) {
                    todayChats.push(chat);
                } else if (chatDate.toDateString() === yesterday.toDateString()) {
                    yesterdayChats.push(chat);
                } else if (chatDate > weekAgo) {
                    weekChats.push(chat);
                } else {
                    olderChats.push(chat);
                }
            });

            let html = '';

            if (todayChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Today</div>
                    ${todayChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (yesterdayChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Yesterday</div>
                    ${yesterdayChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (weekChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">This Week</div>
                    ${weekChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            if (olderChats.length > 0) {
                html += `<div class="history-section">
                    <div class="history-section-title">Older</div>
                    ${olderChats.map(chat => renderChatItem(chat)).join('')}
                </div>`;
            }

            chatHistoryContainer.innerHTML = html;
        }

        function renderChatItem(chat) {
            const isActive = chat.id === currentChatId ? 'active' : '';
            return `
                <div class="chat-item ${isActive}" onclick="loadChat('${chat.id}')">
                    <span class="chat-item-icon">üí¨</span>
                    <span class="chat-item-text">${chat.title}</span>
                    <span class="chat-item-delete" onclick="deleteChat('${chat.id}', event)">üóëÔ∏è</span>
                </div>
            `;
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function useSuggestion(text) {
            userInput.value = text;
            sendMessage();
        }

        function addMessageToDOM(role, content) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'assistant' ? '‚úß' : '‚ö°';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return contentDiv;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'typing-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = '‚úß';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function formatMessage(content) {
            // Process code blocks first (preserve them)
            const codeBlocks = [];
            content = content.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                codeBlocks.push(`<pre><code>${escapeHtml(code.trim())}</code></pre>`);
                return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
            });

            // Inline code
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            content = content.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            content = content.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            content = content.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Blockquotes
            content = content.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

            // Horizontal rules
            content = content.replace(/^---$/gm, '<hr>');

            // Bold and italic
            content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Links
            content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Unordered lists
            content = content.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            content = content.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Numbered lists
            content = content.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // Paragraphs - split by double newlines
            const parts = content.split(/\n\n+/);
            content = parts.map(part => {
                part = part.trim();
                if (!part) return '';
                // Don't wrap if already has block element
                if (part.startsWith('<h') || part.startsWith('<ul') || part.startsWith('<ol') ||
                    part.startsWith('<pre') || part.startsWith('<blockquote') || part.startsWith('<hr') ||
                    part.startsWith('__CODE_BLOCK_')) {
                    return part;
                }
                // Convert single newlines to <br> within paragraphs
                part = part.replace(/\n/g, '<br>');
                return `<p>${part}</p>`;
            }).join('');

            // Restore code blocks
            codeBlocks.forEach((block, i) => {
                content = content.replace(`__CODE_BLOCK_${i}__`, block);
            });

            // Clean up empty paragraphs
            content = content.replace(/<p><\/p>/g, '');
            content = content.replace(/<p>(<(?:ul|ol|pre|blockquote|h[1-3]|hr)[^>]*>)/g, '$1');
            content = content.replace(/(<\/(?:ul|ol|pre|blockquote|h[1-3])>)<\/p>/g, '$1');

            return content;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function saveMessage(chatId, role, content) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            chat.messages.push({
                id: 'msg_' + Date.now(),
                role: role,
                content: content,
                created_at: new Date().toISOString()
            });
            chat.updatedAt = new Date().toISOString();

            // Update title if first user message
            if (role === 'user' && chat.messages.filter(m => m.role === 'user').length === 1) {
                chat.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                renderChatHistory();
            }

            saveChatsToStorage();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isGenerating) return;

            if (!GROQ_API_KEY) {
                addMessageToDOM('assistant', 'API key not configured. Please contact the administrator.');
                return;
            }

            isGenerating = true;
            sendBtn.disabled = true;
            userInput.value = '';
            userInput.style.height = 'auto';

            addMessageToDOM('user', message);
            conversationHistory.push({ role: 'user', content: message });

            // Save user message
            saveMessage(currentChatId, 'user', message);

            addTypingIndicator();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: `You are NexusAI, a highly advanced AI assistant.

RESPONSE FORMAT - FOLLOW STRICTLY:
- Be CONCISE and get straight to the point
- Use numbered steps (1. 2. 3.) for any process or instructions
- Use bullet points for lists of items or options
- Keep each point SHORT - one line when possible
- NO long paragraphs - break everything into digestible chunks
- Start with a brief 1-sentence summary if needed, then steps/points
- Use headers (## or ###) to organize longer responses into sections

STYLE RULES:
- Skip filler phrases like "Certainly!", "Great question!", "I'd be happy to help"
- Just answer directly
- No excessive symbols, emojis, or decorations
- Use code blocks only for actual code
- Bold only key terms that need emphasis

Example format:
## Quick Answer
One sentence summary.

### Steps
1. First thing to do
2. Second thing to do
3. Third thing to do

### Key Points
- Important point one
- Important point two`
                            },
                            ...conversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                conversationHistory.push({ role: 'assistant', content: assistantMessage });
                addMessageToDOM('assistant', assistantMessage);

                // Save assistant message
                saveMessage(currentChatId, 'assistant', assistantMessage);

            } catch (error) {
                removeTypingIndicator();
                addMessageToDOM('assistant', 'My neural pathways encountered a disturbance. Please try again.');
                console.error('Error:', error);
            }

            isGenerating = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // Handle enter key on sign-in input
        signinEmail.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleSignIn();
        });
    </script>
</body>
</html>
